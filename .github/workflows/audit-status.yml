name: Audit Status

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base ref for delta analysis (tag, commit, or branch)'
        required: false
        default: ''

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit-analysis:
    name: Analyze for Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for delta analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download audit analyzer
        run: |
          # In production, this would fetch from a releases URL or be included in the repo
          # For now, we'll create it inline
          mkdir -p .audit-tools
          cat > .audit-tools/audit_analyzer.py << 'ANALYZER_EOF'
          # [The full audit_analyzer.py content would go here]
          # For the action, we'll fetch it from a URL or include it
          ANALYZER_EOF

      - name: Determine base reference
        id: base-ref
        run: |
          if [ -n "${{ github.event.inputs.base_ref }}" ]; then
            echo "base=${{ github.event.inputs.base_ref }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "release" ]; then
            # Find previous tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            echo "base=$PREV_TAG" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            # For push, compare with previous commit or last tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              echo "base=$PREV_TAG" >> $GITHUB_OUTPUT
            else
              echo "base=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run audit analysis
        id: analyze
        run: |
          python3 .audit-tools/audit_analyzer.py . \
            --base "${{ steps.base-ref.outputs.base }}" \
            --format markdown \
            --output audit-report.md

          python3 .audit-tools/audit_analyzer.py . \
            --base "${{ steps.base-ref.outputs.base }}" \
            --format json \
            --output audit-report.json

          # Extract key metrics for step summary
          echo "## Audit Analysis Complete" >> $GITHUB_STEP_SUMMARY
          cat audit-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: |
            audit-report.md
            audit-report.json

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('üîç Audit Report')
            );

            const body = `## ü§ñ Automated Audit Analysis

            ${report}

            <sub>This analysis helps prepare for [cargo-vet](https://mozilla.github.io/cargo-vet/) auditing.
            It does not replace human review.</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Create/Update Release Audit Issue
        if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            const reportJson = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));

            const tagName = context.ref.replace('refs/tags/', '');
            const issueTitle = `üîç Audit Preparation: ${tagName}`;

            // Check for existing issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'audit-prep'
            });

            const existingIssue = issues.find(i => i.title === issueTitle);

            const body = `# Audit Preparation for ${tagName}

            This issue tracks the audit readiness for release ${tagName}.

            ${report}

            ## Audit Checklist

            - [ ] Review all unsafe blocks listed above
            - [ ] Verify filesystem/network usage is appropriate
            - [ ] Check new dependencies have existing audits
            - [ ] Update cargo-vet audits.toml after review

            ## For Google Auditors

            Once reviewed, add to \`audits.toml\`:

            \`\`\`toml
            [[audits.${reportJson.crate_name}]]
            who = "Your Name <your.email@example.com>"
            criteria = ["safe-to-deploy", "does-not-implement-crypto"]  # Adjust based on review
            version = "${reportJson.version}"
            notes = "Delta review from ${reportJson.base_version || 'initial'}"
            \`\`\`

            ---
            *Auto-generated by audit-status workflow*`;

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body,
                labels: ['audit-prep', 'documentation']
              });
              console.log(`Created issue #${newIssue.number}`);
            }
